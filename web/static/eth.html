<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ETH Dashboard - Polymarket Strategy Tester v2.1</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <div class="container">
        <header>
            <div class="header-left">
                <a href="/" class="back-btn">‚Üê Main Dashboard</a>
                <h1>
                    <span class="coin-icon">Œû</span>
                    Ethereum (ETH)
                </h1>
            </div>
            <div class="controls">
                <span class="runtime" id="runtime">00:00:00</span>
                <span id="status-badge" class="status-badge status-stopped">STOPPED</span>
                <button id="start-btn" class="btn-start" onclick="startEngine()">Start</button>
                <button id="stop-btn" class="btn-stop" onclick="stopEngine()">Stop</button>
            </div>
        </header>

        <!-- Market Info -->
        <div class="grid">
            <div class="card">
                <div class="card-title">T+1 Market</div>
                <div class="market-info">
                    <div class="market-row">
                        <span class="market-label">Slug</span>
                        <span class="market-value" id="market-slug">--</span>
                    </div>
                    <!-- Polymarket-style countdown (like T+1 17:56) -->
                    <div class="countdown" id="countdown">--:--</div>
                    <div
                        style="text-align: center; color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 10px;">
                        Market Countdown (T+1)</div>

                    <!-- Entry Window Status -->
                    <div class="entry-window-status">
                        <div class="entry-status-indicator" id="entry-status">
                            <span class="status-icon" id="entry-icon">‚è∏Ô∏è</span>
                            <span class="status-text" id="entry-text">Waiting</span>
                        </div>
                        <div class="entry-countdown" id="entry-window-countdown">--:--</div>
                        <div style="text-align: center; color: var(--text-secondary); font-size: 0.75rem;">Entry Window
                            (5 min)</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-title">Current Prices</div>
                <div class="market-info">
                    <div class="market-row">
                        <span class="market-label">UP Price</span>
                        <span class="market-value price-up" id="up-price">$--</span>
                    </div>
                    <div class="market-row">
                        <span class="market-label">DOWN Price</span>
                        <span class="market-value price-down" id="down-price">$--</span>
                    </div>
                    <div class="market-row">
                        <span class="market-label">Sum</span>
                        <span class="market-value" id="sum-price">$--</span>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-title">Entry Conditions</div>
                <div class="market-info">
                    <div class="market-row">
                        <span class="market-label">Undervalued (‚â§)</span>
                        <span class="market-value" id="threshold-undervalued">$0.48</span>
                    </div>
                    <div class="market-row">
                        <span class="market-label">Momentum (‚â•)</span>
                        <span class="market-value" id="threshold-momentum">$0.52</span>
                    </div>
                    <div class="market-row">
                        <span class="market-label">Order Size</span>
                        <span class="market-value" id="order-size">10 shares</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Strategy Comparison - All 8 Variants -->
        <h2 class="section-title" style="margin-bottom: 20px;">Strategy Comparison (8 Variants)</h2>
        <div class="card">
            <table class="trades-table" id="variants-table">
                <thead>
                    <tr>
                        <th>Strategy</th>
                        <th>Threshold</th>
                        <th>Trades</th>
                        <th>Wins</th>
                        <th>Losses</th>
                        <th>Win Rate</th>
                        <th>P&L</th>
                        <th>Volume</th>
                        <th>ROI</th>
                    </tr>
                </thead>
                <tbody id="variants-body">
                    <!-- Undervalued variants -->
                    <tr class="variant-row undervalued">
                        <td>üìâ Undervalued</td>
                        <td>‚â§ $0.49</td>
                        <td id="undervalued_49-trades">0</td>
                        <td id="undervalued_49-wins">0</td>
                        <td id="undervalued_49-losses">0</td>
                        <td id="undervalued_49-winrate">0%</td>
                        <td id="undervalued_49-pnl">$0.00</td>
                        <td id="undervalued_49-volume">$0.00</td>
                        <td id="undervalued_49-roi">0%</td>
                    </tr>
                    <tr class="variant-row undervalued">
                        <td>üìâ Undervalued</td>
                        <td>‚â§ $0.48</td>
                        <td id="undervalued_48-trades">0</td>
                        <td id="undervalued_48-wins">0</td>
                        <td id="undervalued_48-losses">0</td>
                        <td id="undervalued_48-winrate">0%</td>
                        <td id="undervalued_48-pnl">$0.00</td>
                        <td id="undervalued_48-volume">$0.00</td>
                        <td id="undervalued_48-roi">0%</td>
                    </tr>
                    <tr class="variant-row undervalued">
                        <td>üìâ Undervalued</td>
                        <td>‚â§ $0.47</td>
                        <td id="undervalued_47-trades">0</td>
                        <td id="undervalued_47-wins">0</td>
                        <td id="undervalued_47-losses">0</td>
                        <td id="undervalued_47-winrate">0%</td>
                        <td id="undervalued_47-pnl">$0.00</td>
                        <td id="undervalued_47-volume">$0.00</td>
                        <td id="undervalued_47-roi">0%</td>
                    </tr>
                    <tr class="variant-row undervalued">
                        <td>üìâ Undervalued</td>
                        <td>‚â§ $0.46</td>
                        <td id="undervalued_46-trades">0</td>
                        <td id="undervalued_46-wins">0</td>
                        <td id="undervalued_46-losses">0</td>
                        <td id="undervalued_46-winrate">0%</td>
                        <td id="undervalued_46-pnl">$0.00</td>
                        <td id="undervalued_46-volume">$0.00</td>
                        <td id="undervalued_46-roi">0%</td>
                    </tr>
                    <!-- Momentum variants -->
                    <tr class="variant-row momentum">
                        <td>üìà Momentum</td>
                        <td>‚â• $0.51</td>
                        <td id="momentum_51-trades">0</td>
                        <td id="momentum_51-wins">0</td>
                        <td id="momentum_51-losses">0</td>
                        <td id="momentum_51-winrate">0%</td>
                        <td id="momentum_51-pnl">$0.00</td>
                        <td id="momentum_51-volume">$0.00</td>
                        <td id="momentum_51-roi">0%</td>
                    </tr>
                    <tr class="variant-row momentum">
                        <td>üìà Momentum</td>
                        <td>‚â• $0.52</td>
                        <td id="momentum_52-trades">0</td>
                        <td id="momentum_52-wins">0</td>
                        <td id="momentum_52-losses">0</td>
                        <td id="momentum_52-winrate">0%</td>
                        <td id="momentum_52-pnl">$0.00</td>
                        <td id="momentum_52-volume">$0.00</td>
                        <td id="momentum_52-roi">0%</td>
                    </tr>
                    <tr class="variant-row momentum">
                        <td>üìà Momentum</td>
                        <td>‚â• $0.53</td>
                        <td id="momentum_53-trades">0</td>
                        <td id="momentum_53-wins">0</td>
                        <td id="momentum_53-losses">0</td>
                        <td id="momentum_53-winrate">0%</td>
                        <td id="momentum_53-pnl">$0.00</td>
                        <td id="momentum_53-volume">$0.00</td>
                        <td id="momentum_53-roi">0%</td>
                    </tr>
                    <tr class="variant-row momentum">
                        <td>üìà Momentum</td>
                        <td>‚â• $0.54</td>
                        <td id="momentum_54-trades">0</td>
                        <td id="momentum_54-wins">0</td>
                        <td id="momentum_54-losses">0</td>
                        <td id="momentum_54-winrate">0%</td>
                        <td id="momentum_54-pnl">$0.00</td>
                        <td id="momentum_54-volume">$0.00</td>
                        <td id="momentum_54-roi">0%</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Strategy Visualizations Section -->
        <h2 class="section-title" style="margin-top: 30px; margin-bottom: 20px;">üìà Performance Visualizations</h2>

        <!-- Charts Grid -->
        <div class="charts-grid">
            <!-- Option 1: ROI Horizontal Bar Chart -->
            <div class="card chart-card">
                <div class="card-title">ROI Comparison</div>
                <div class="chart-container">
                    <canvas id="roiBarChart"></canvas>
                </div>
            </div>

            <!-- Option 2: Cumulative P&L Line Chart -->
            <div class="card chart-card">
                <div class="card-title">Cumulative P&L Over Time</div>
                <div class="chart-container">
                    <canvas id="pnlLineChart"></canvas>
                </div>
            </div>

            <!-- Option 3: Win Rate Donut Charts -->
            <div class="card chart-card">
                <div class="card-title">Win Rates by Strategy</div>
                <div class="donut-grid" id="donutCharts">
                    <div class="donut-item">
                        <canvas id="donut-undervalued_49"></canvas>
                        <span class="donut-label">‚â§$0.49</span>
                    </div>
                    <div class="donut-item">
                        <canvas id="donut-undervalued_48"></canvas>
                        <span class="donut-label">‚â§$0.48</span>
                    </div>
                    <div class="donut-item">
                        <canvas id="donut-undervalued_47"></canvas>
                        <span class="donut-label">‚â§$0.47</span>
                    </div>
                    <div class="donut-item">
                        <canvas id="donut-undervalued_46"></canvas>
                        <span class="donut-label">‚â§$0.46</span>
                    </div>
                    <div class="donut-item">
                        <canvas id="donut-momentum_51"></canvas>
                        <span class="donut-label">‚â•$0.51</span>
                    </div>
                    <div class="donut-item">
                        <canvas id="donut-momentum_52"></canvas>
                        <span class="donut-label">‚â•$0.52</span>
                    </div>
                    <div class="donut-item">
                        <canvas id="donut-momentum_53"></canvas>
                        <span class="donut-label">‚â•$0.53</span>
                    </div>
                    <div class="donut-item">
                        <canvas id="donut-momentum_54"></canvas>
                        <span class="donut-label">‚â•$0.54</span>
                    </div>
                </div>
            </div>

            <!-- Option 5: Grouped Bar Chart (Undervalued vs Momentum) -->
            <div class="card chart-card">
                <div class="card-title">Undervalued vs Momentum</div>
                <div class="chart-container">
                    <canvas id="groupedBarChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Option 4: Sparklines Table -->
        <div class="card" style="margin-top: 20px;">
            <div class="card-title">P&L Sparklines (Last 10 Trades per Variant)</div>
            <div class="sparklines-grid" id="sparklinesContainer">
                <div class="sparkline-row">
                    <span class="sparkline-label">Undervalued ‚â§$0.49</span>
                    <div class="sparkline-chart"><canvas id="sparkline-undervalued_49"></canvas></div>
                    <span class="sparkline-value" id="sparkline-value-undervalued_49">$0.00</span>
                </div>
                <div class="sparkline-row">
                    <span class="sparkline-label">Undervalued ‚â§$0.48</span>
                    <div class="sparkline-chart"><canvas id="sparkline-undervalued_48"></canvas></div>
                    <span class="sparkline-value" id="sparkline-value-undervalued_48">$0.00</span>
                </div>
                <div class="sparkline-row">
                    <span class="sparkline-label">Undervalued ‚â§$0.47</span>
                    <div class="sparkline-chart"><canvas id="sparkline-undervalued_47"></canvas></div>
                    <span class="sparkline-value" id="sparkline-value-undervalued_47">$0.00</span>
                </div>
                <div class="sparkline-row">
                    <span class="sparkline-label">Undervalued ‚â§$0.46</span>
                    <div class="sparkline-chart"><canvas id="sparkline-undervalued_46"></canvas></div>
                    <span class="sparkline-value" id="sparkline-value-undervalued_46">$0.00</span>
                </div>
                <div class="sparkline-row">
                    <span class="sparkline-label">Momentum ‚â•$0.51</span>
                    <div class="sparkline-chart"><canvas id="sparkline-momentum_51"></canvas></div>
                    <span class="sparkline-value" id="sparkline-value-momentum_51">$0.00</span>
                </div>
                <div class="sparkline-row">
                    <span class="sparkline-label">Momentum ‚â•$0.52</span>
                    <div class="sparkline-chart"><canvas id="sparkline-momentum_52"></canvas></div>
                    <span class="sparkline-value" id="sparkline-value-momentum_52">$0.00</span>
                </div>
                <div class="sparkline-row">
                    <span class="sparkline-label">Momentum ‚â•$0.53</span>
                    <div class="sparkline-chart"><canvas id="sparkline-momentum_53"></canvas></div>
                    <span class="sparkline-value" id="sparkline-value-momentum_53">$0.00</span>
                </div>
                <div class="sparkline-row">
                    <span class="sparkline-label">Momentum ‚â•$0.54</span>
                    <div class="sparkline-chart"><canvas id="sparkline-momentum_54"></canvas></div>
                    <span class="sparkline-value" id="sparkline-value-momentum_54">$0.00</span>
                </div>
            </div>
        </div>

        <!-- Open Orders -->
        <div class="card" style="margin-top: 30px;">
            <div class="section-header">
                <div class="card-title" style="margin-bottom: 0;">Open Orders</div>
                <div class="export-btns">
                    <button class="export-btn" onclick="exportOrders('txt')">üìÑ TXT</button>
                    <button class="export-btn" onclick="exportOrders('md')">üìù MD</button>
                </div>
            </div>
            <div class="table-container collapsed" id="orders-container">
                <table class="trades-table">
                    <thead>
                        <tr>
                            <th>Strategy</th>
                            <th>Market</th>
                            <th>Side</th>
                            <th>Limit Price</th>
                            <th>Filled/Size</th>
                            <th>Status</th>
                            <th>Created At</th>
                            <th>Market Time</th>
                        </tr>
                    </thead>
                    <tbody id="orders-body">
                        <tr>
                            <td colspan="8" class="empty-state">No orders.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="table-info" id="orders-info"></div>
            <button class="show-all-btn" id="orders-toggle" onclick="toggleOrders()" style="display: none;">
                Show All Orders ‚ñº
            </button>
        </div>

        <!-- Recent Trades -->
        <div class="card" style="margin-top: 30px;">
            <div class="section-header">
                <div class="card-title" style="margin-bottom: 0;">Recent Trades</div>
                <div class="export-btns">
                    <button class="export-btn" onclick="exportTrades('txt')">üìÑ TXT</button>
                    <button class="export-btn" onclick="exportTrades('md')">üìù MD</button>
                </div>
            </div>
            <div class="table-container collapsed" id="trades-container">
                <table class="trades-table">
                    <thead>
                        <tr>
                            <th>Strategy</th>
                            <th>Market</th>
                            <th>Outcome</th>
                            <th>Entry</th>
                            <th>Filled</th>
                            <th>Filled At</th>
                            <th>Result</th>
                            <th>P&L</th>
                            <th>Market Time</th>
                        </tr>
                    </thead>
                    <tbody id="trades-body">
                        <tr>
                            <td colspan="9" class="empty-state">No trades yet. Start the engine to begin testing.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="table-info" id="trades-info"></div>
            <button class="show-all-btn" id="trades-toggle" onclick="toggleTrades()" style="display: none;">
                Show All Trades ‚ñº
            </button>
        </div>
    </div>

    <script>
        const COIN = 'eth';
        let ws = null;
        let engineStartTime = null;
        let runtimeInterval = null;
        let showAllOrders = false;
        let showAllTrades = false;
        let ordersTotal = 0;
        let tradesTotal = 0;

        document.addEventListener('DOMContentLoaded', () => {
            connectWebSocket();
        });

        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/${COIN}`;

            ws = new WebSocket(wsUrl);

            ws.onopen = () => console.log('WebSocket connected');
            ws.onmessage = (event) => updateDashboard(JSON.parse(event.data));
            ws.onclose = () => setTimeout(connectWebSocket, 3000);
            ws.onerror = (error) => console.error('WebSocket error:', error);
        }

        function updateDashboard(data) {
            updateEngineStatus(data.engine);
            updateMarkets(data.markets);
            updatePrices(data.prices);
            updateVariantMetrics(data.variant_metrics);
            updateOrders(data.orders || [], data.orders_total || 0);
            updateTrades(data.trades || [], data.trades_total || 0);
        }

        function updateEngineStatus(engine) {
            if (!engine) return;
            const badge = document.getElementById('status-badge');

            if (engine.is_running) {
                badge.textContent = 'RUNNING';
                badge.className = 'status-badge status-running';

                if (engine.start_time) {
                    if (!engineStartTime || engineStartTime !== engine.start_time) {
                        engineStartTime = engine.start_time;
                        if (runtimeInterval) clearInterval(runtimeInterval);
                        runtimeInterval = setInterval(updateRuntime, 1000);
                        updateRuntime();
                    }
                }
            } else {
                badge.textContent = 'STOPPED';
                badge.className = 'status-badge status-stopped';

                if (runtimeInterval) {
                    clearInterval(runtimeInterval);
                    runtimeInterval = null;
                    engineStartTime = null;
                    document.getElementById('runtime').textContent = '00:00:00';
                }
            }
        }

        function updateRuntime() {
            if (!engineStartTime) return;
            const now = Date.now() / 1000;
            const diff = Math.floor(now - engineStartTime);
            if (diff < 0) return;

            const hours = Math.floor(diff / 3600);
            const minutes = Math.floor((diff % 3600) / 60);
            const seconds = diff % 60;

            document.getElementById('runtime').textContent =
                `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function updateMarkets(markets) {
            if (!markets) return;
            const t1 = markets.t1_market;
            if (t1) {
                document.getElementById('market-slug').textContent = t1.slug || '--';
                const countdown = t1.countdown_to_active || 0;
                const minutes = Math.floor(countdown / 60);
                const seconds = countdown % 60;

                // Display market countdown (Polymarket-style)
                document.getElementById('countdown').textContent =
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

                // Entry window constants (in seconds)
                const ENTRY_START = 1230;  // 20:30
                const ENTRY_END = 930;     // 15:30
                const WINDOW_DURATION = ENTRY_START - ENTRY_END; // 5 minutes = 300s

                // Calculate entry window countdown and status
                const entryIcon = document.getElementById('entry-icon');
                const entryText = document.getElementById('entry-text');
                const entryCountdown = document.getElementById('entry-window-countdown');
                const entryStatus = document.getElementById('entry-status');

                if (countdown > ENTRY_START) {
                    // Waiting for entry window to open
                    const timeUntilOpen = countdown - ENTRY_START;
                    const waitMins = Math.floor(timeUntilOpen / 60);
                    const waitSecs = timeUntilOpen % 60;
                    entryIcon.textContent = '‚è∏Ô∏è';
                    entryText.textContent = 'Waiting';
                    entryCountdown.textContent = `${waitMins.toString().padStart(2, '0')}:${waitSecs.toString().padStart(2, '0')}`;
                    entryStatus.className = 'entry-status-indicator status-waiting';
                } else if (countdown >= ENTRY_END && countdown <= ENTRY_START) {
                    // INSIDE entry window - placing orders
                    const timeRemaining = countdown - ENTRY_END;
                    const windowMins = Math.floor(timeRemaining / 60);
                    const windowSecs = timeRemaining % 60;
                    entryIcon.textContent = 'üü¢';
                    entryText.textContent = 'Placing Orders';
                    entryCountdown.textContent = `${windowMins.toString().padStart(2, '0')}:${windowSecs.toString().padStart(2, '0')}`;
                    entryStatus.className = 'entry-status-indicator status-active';
                } else {
                    // Entry window closed
                    entryIcon.textContent = 'üî¥';
                    entryText.textContent = 'Window Closed';
                    entryCountdown.textContent = '00:00';
                    entryStatus.className = 'entry-status-indicator status-closed';
                }
            }
        }

        function updatePrices(prices) {
            if (!prices) {
                document.getElementById('up-price').textContent = '$--';
                document.getElementById('down-price').textContent = '$--';
                document.getElementById('sum-price').textContent = '$--';
                return;
            }

            document.getElementById('up-price').textContent = prices.up ? `$${prices.up.toFixed(2)}` : '$--';
            document.getElementById('down-price').textContent = prices.down ? `$${prices.down.toFixed(2)}` : '$--';
            document.getElementById('sum-price').textContent = prices.sum ? `$${prices.sum.toFixed(2)}` : '$--';
        }

        function updateVariantMetrics(variantMetrics) {
            if (!variantMetrics) return;

            // All 8 variants to update
            const variants = [
                'undervalued_49', 'undervalued_48', 'undervalued_47', 'undervalued_46',
                'momentum_51', 'momentum_52', 'momentum_53', 'momentum_54'
            ];

            variants.forEach(variant => {
                const v = variantMetrics[variant];
                if (!v) return;

                const setEl = (suffix, value) => {
                    const el = document.getElementById(`${variant}-${suffix}`);
                    if (el) el.textContent = value;
                };

                setEl('trades', v.total_trades);
                setEl('wins', v.wins);
                setEl('losses', v.losses);
                setEl('winrate', `${v.win_rate}%`);
                setEl('volume', `$${v.total_invested.toFixed(2)}`);
                setEl('roi', `${v.roi}%`);

                // P&L with color
                const pnlEl = document.getElementById(`${variant}-pnl`);
                if (pnlEl) {
                    pnlEl.textContent = `$${v.total_pnl.toFixed(2)}`;
                    pnlEl.className = v.total_pnl >= 0 ? 'pnl-positive' : 'pnl-negative';
                }
            });

            // Update all charts with new metrics
            updateCharts(variantMetrics);
        }

        function updateOrders(orders, total) {
            const tbody = document.getElementById('orders-body');
            const toggleBtn = document.getElementById('orders-toggle');
            const info = document.getElementById('orders-info');
            const container = document.getElementById('orders-container');

            // If expanded and total changed, refetch all orders
            if (showAllOrders && total !== ordersTotal) {
                ordersTotal = total;
                fetchAllOrders();
                return;
            }

            // If expanded, don't update from limited WebSocket data
            if (showAllOrders) {
                // Just update the info text with current total
                info.textContent = `Showing all ${ordersTotal} orders`;
                return;
            }

            ordersTotal = total;

            if (!orders || orders.length === 0) {
                tbody.innerHTML = `<tr><td colspan="8" class="empty-state">No orders.</td></tr>`;
                toggleBtn.style.display = 'none';
                info.textContent = '';
                return;
            }

            renderOrdersTable(orders, total);
            info.textContent = `Showing ${orders.length} of ${total} orders`;
            toggleBtn.style.display = total > 8 ? 'block' : 'none';
            toggleBtn.textContent = 'Show All Orders ‚ñº';
        }

        function renderOrdersTable(orders, total) {
            const tbody = document.getElementById('orders-body');
            tbody.innerHTML = orders.map(order => {
                const statusClass = order.status === 'filled' ? 'result-win' :
                    order.status === 'open' ? 'result-pending' : 'result-loss';
                const createdTime = order.created_at ? new Date(order.created_at * 1000).toLocaleTimeString() : '--';
                const marketShort = order.market_slug ? order.market_slug.slice(-10) : '--';
                const filledPct = order.size > 0 ? Math.round((order.filled_size / order.size) * 100) : 0;
                const marketTime = order.market_time || formatMarketTime(order.market_slug);

                return `
                    <tr>
                        <td>${order.strategy}</td>
                        <td title="${order.market_slug}">${marketShort}</td>
                        <td>${order.outcome}</td>
                        <td>$${order.price.toFixed(2)}</td>
                        <td>${order.filled_size}/${order.size} (${filledPct}%)</td>
                        <td class="${statusClass}">${order.status.toUpperCase()}</td>
                        <td>${createdTime}</td>
                        <td>${marketTime}</td>
                    </tr>
                `;
            }).join('');
        }

        function updateTrades(trades, total) {
            const tbody = document.getElementById('trades-body');
            const toggleBtn = document.getElementById('trades-toggle');
            const info = document.getElementById('trades-info');
            const container = document.getElementById('trades-container');

            // If expanded and total changed, refetch all trades
            if (showAllTrades && total !== tradesTotal) {
                tradesTotal = total;
                fetchAllTrades();
                return;
            }

            // If expanded, don't update from limited WebSocket data
            if (showAllTrades) {
                // Just update the info text with current total
                info.textContent = `Showing all ${tradesTotal} trades`;
                return;
            }

            tradesTotal = total;

            if (!trades || trades.length === 0) {
                tbody.innerHTML = `<tr><td colspan="9" class="empty-state">No trades yet. Start the engine to begin testing.</td></tr>`;
                toggleBtn.style.display = 'none';
                info.textContent = '';
                return;
            }

            renderTradesTable(trades, total);
            info.textContent = `Showing ${trades.length} of ${total} trades`;
            toggleBtn.style.display = total > 8 ? 'block' : 'none';
            toggleBtn.textContent = 'Show All Trades ‚ñº';
        }

        function renderTradesTable(trades, total) {
            const tbody = document.getElementById('trades-body');
            tbody.innerHTML = trades.map(trade => {
                const resultClass = trade.result === 'win' ? 'result-win' :
                    trade.result === 'loss' ? 'result-loss' : 'result-pending';
                const pnlClass = trade.pnl >= 0 ? 'pnl-positive' : 'pnl-negative';
                const fillTime = trade.entry_time ? new Date(trade.entry_time * 1000).toLocaleTimeString() : '--';
                const filledInfo = trade.filled_size !== undefined
                    ? `${trade.filled_size}/${trade.size}`
                    : `${trade.size}`;
                const marketShort = trade.market_slug ? trade.market_slug.slice(-10) : '--';
                const marketTime = trade.market_time || formatMarketTime(trade.market_slug);

                return `
                    <tr>
                        <td>${trade.strategy}</td>
                        <td title="${trade.market_slug}">${marketShort}</td>
                        <td>${trade.outcome}</td>
                        <td>$${trade.entry_price.toFixed(2)}</td>
                        <td>${filledInfo}</td>
                        <td>${fillTime}</td>
                        <td class="${resultClass}">${trade.result.toUpperCase()}</td>
                        <td class="${pnlClass}">$${trade.pnl.toFixed(2)}</td>
                        <td>${marketTime}</td>
                    </tr>
                `;
            }).join('');
        }

        function formatMarketTime(marketSlug) {
            if (!marketSlug) return '--';
            try {
                const parts = marketSlug.split('-');
                const timestamp = parseInt(parts[parts.length - 1]);
                if (isNaN(timestamp)) return '--';

                const start = new Date(timestamp * 1000);
                const end = new Date((timestamp + 900) * 1000);

                const options = { month: 'short', day: 'numeric' };
                const timeOptions = { hour: 'numeric', minute: '2-digit', hour12: true, timeZone: 'America/New_York' };

                const dateStr = start.toLocaleDateString('en-US', options);
                const startTime = start.toLocaleTimeString('en-US', timeOptions);
                const endTime = end.toLocaleTimeString('en-US', timeOptions);

                return `${dateStr}, ${startTime}‚Äì${endTime} ET`;
            } catch (e) {
                return '--';
            }
        }

        async function fetchAllOrders() {
            try {
                const response = await fetch(`/api/orders?coin=${COIN}`);
                const data = await response.json();
                renderOrdersTable(data.orders, data.total);
                document.getElementById('orders-info').textContent = `Showing all ${data.total} orders`;
            } catch (error) {
                console.error('Error fetching all orders:', error);
            }
        }

        async function fetchAllTrades() {
            try {
                const response = await fetch(`/api/trades?coin=${COIN}`);
                const data = await response.json();
                renderTradesTable(data.trades, data.total);
                document.getElementById('trades-info').textContent = `Showing all ${data.total} trades`;
            } catch (error) {
                console.error('Error fetching all trades:', error);
            }
        }

        async function toggleOrders() {
            showAllOrders = !showAllOrders;
            const container = document.getElementById('orders-container');
            const toggleBtn = document.getElementById('orders-toggle');
            container.classList.toggle('collapsed', !showAllOrders);

            if (showAllOrders) {
                toggleBtn.textContent = 'Show Less ‚ñ≤';
                await fetchAllOrders();
            } else {
                toggleBtn.textContent = 'Show All Orders ‚ñº';
                // Will be updated on next WebSocket message
            }
        }

        async function toggleTrades() {
            showAllTrades = !showAllTrades;
            const container = document.getElementById('trades-container');
            const toggleBtn = document.getElementById('trades-toggle');
            container.classList.toggle('collapsed', !showAllTrades);

            if (showAllTrades) {
                toggleBtn.textContent = 'Show Less ‚ñ≤';
                await fetchAllTrades();
            } else {
                toggleBtn.textContent = 'Show All Trades ‚ñº';
                // Will be updated on next WebSocket message
            }
        }

        async function exportOrders(format) {
            const url = `/api/export/orders?format=${format}&coin=${COIN}`;
            try {
                const response = await fetch(url);
                const blob = await response.blob();
                const filename = response.headers.get('Content-Disposition')?.split('filename=')[1] || `orders_export.${format}`;
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(link.href);
            } catch (error) {
                console.error('Export error:', error);
                alert('Export failed. Please try again.');
            }
        }

        async function exportTrades(format) {
            const url = `/api/export/trades?format=${format}&coin=${COIN}`;
            try {
                const response = await fetch(url);
                const blob = await response.blob();
                const filename = response.headers.get('Content-Disposition')?.split('filename=')[1] || `trades_export.${format}`;
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(link.href);
            } catch (error) {
                console.error('Export error:', error);
                alert('Export failed. Please try again.');
            }
        }

        async function startEngine() {
            try {
                await fetch(`/api/coins/${COIN}/start`, { method: 'POST' });
            } catch (error) {
                console.error('Error starting engine:', error);
            }
        }

        async function stopEngine() {
            try {
                await fetch(`/api/coins/${COIN}/stop`, { method: 'POST' });
            } catch (error) {
                console.error('Error stopping engine:', error);
            }
        }

        // ==================== CHART INITIALIZATION ====================

        let roiBarChart = null;
        let pnlLineChart = null;
        let groupedBarChart = null;
        let donutCharts = {};
        let sparklineCharts = {};
        let pnlHistory = [];
        let tradeCount = 0;

        const VARIANTS = [
            'undervalued_49', 'undervalued_48', 'undervalued_47', 'undervalued_46',
            'momentum_51', 'momentum_52', 'momentum_53', 'momentum_54'
        ];

        const UNDERVALUED_COLORS = ['#10b981', '#34d399', '#6ee7b7', '#a7f3d0'];
        const MOMENTUM_COLORS = ['#3b82f6', '#60a5fa', '#93c5fd', '#bfdbfe'];

        function initCharts() {
            initRoiBarChart();
            initPnlLineChart();
            initGroupedBarChart();
            initDonutCharts();
            initSparklines();
        }

        function initRoiBarChart() {
            const ctx = document.getElementById('roiBarChart');
            if (!ctx) return;

            roiBarChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['‚â§$0.49', '‚â§$0.48', '‚â§$0.47', '‚â§$0.46', '‚â•$0.51', '‚â•$0.52', '‚â•$0.53', '‚â•$0.54'],
                    datasets: [{
                        label: 'ROI %',
                        data: [0, 0, 0, 0, 0, 0, 0, 0],
                        backgroundColor: [...UNDERVALUED_COLORS, ...MOMENTUM_COLORS],
                        borderRadius: 4
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { display: false }, ticks: { callback: v => v + '%' } },
                        y: { grid: { display: false } }
                    }
                }
            });
        }

        function initPnlLineChart() {
            const ctx = document.getElementById('pnlLineChart');
            if (!ctx) return;

            pnlLineChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: VARIANTS.map((v, i) => ({
                        label: v.replace('_', ' '),
                        data: [],
                        borderColor: i < 4 ? UNDERVALUED_COLORS[i] : MOMENTUM_COLORS[i - 4],
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        tension: 0.3,
                        pointRadius: 0
                    }))
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { intersect: false, mode: 'index' },
                    plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, padding: 8 } } },
                    scales: {
                        x: { display: true, grid: { display: false } },
                        y: { grid: { color: '#f1f5f9' }, ticks: { callback: v => '$' + v.toFixed(2) } }
                    }
                }
            });
        }

        function initGroupedBarChart() {
            const ctx = document.getElementById('groupedBarChart');
            if (!ctx) return;

            groupedBarChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Trades', 'Wins', 'Losses', 'P&L'],
                    datasets: [
                        { label: 'Undervalued', data: [0, 0, 0, 0], backgroundColor: '#10b981', borderRadius: 4 },
                        { label: 'Momentum', data: [0, 0, 0, 0], backgroundColor: '#3b82f6', borderRadius: 4 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } },
                    scales: {
                        x: { grid: { display: false } },
                        y: { grid: { color: '#f1f5f9' } }
                    }
                }
            });
        }

        function initDonutCharts() {
            VARIANTS.forEach((variant, i) => {
                const ctx = document.getElementById(`donut-${variant}`);
                if (!ctx) return;

                const color = i < 4 ? UNDERVALUED_COLORS[i] : MOMENTUM_COLORS[i - 4];
                donutCharts[variant] = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Wins', 'Losses', 'Pending'],
                        datasets: [{
                            data: [0, 0, 1],
                            backgroundColor: [color, '#ef4444', '#e2e8f0'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        cutout: '65%',
                        plugins: { legend: { display: false } }
                    }
                });
            });
        }

        function initSparklines() {
            VARIANTS.forEach((variant, i) => {
                const ctx = document.getElementById(`sparkline-${variant}`);
                if (!ctx) return;

                const color = i < 4 ? UNDERVALUED_COLORS[i] : MOMENTUM_COLORS[i - 4];
                sparklineCharts[variant] = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: Array(10).fill(''),
                        datasets: [{
                            data: Array(10).fill(0),
                            borderColor: color,
                            backgroundColor: color + '20',
                            fill: true,
                            borderWidth: 2,
                            tension: 0.4,
                            pointRadius: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: { x: { display: false }, y: { display: false } }
                    }
                });
            });
        }

        // ==================== CHART UPDATE FUNCTIONS ====================

        function updateCharts(variantMetrics, trades) {
            if (!variantMetrics) return;

            updateRoiBarChart(variantMetrics);
            updateGroupedBarChart(variantMetrics);
            updateDonutCharts(variantMetrics);
            updatePnlLineChart(variantMetrics, trades);
            updateSparklines(variantMetrics);
            applyHeatmapColors(variantMetrics);
        }

        function updateRoiBarChart(metrics) {
            if (!roiBarChart) return;
            const data = VARIANTS.map(v => metrics[v]?.roi || 0);
            roiBarChart.data.datasets[0].data = data;
            roiBarChart.update('none');
        }

        function updateGroupedBarChart(metrics) {
            if (!groupedBarChart) return;

            let uTrades = 0, uWins = 0, uLosses = 0, uPnl = 0;
            let mTrades = 0, mWins = 0, mLosses = 0, mPnl = 0;

            VARIANTS.forEach(v => {
                const m = metrics[v];
                if (!m) return;
                if (v.startsWith('undervalued')) {
                    uTrades += m.total_trades || 0;
                    uWins += m.wins || 0;
                    uLosses += m.losses || 0;
                    uPnl += m.total_pnl || 0;
                } else {
                    mTrades += m.total_trades || 0;
                    mWins += m.wins || 0;
                    mLosses += m.losses || 0;
                    mPnl += m.total_pnl || 0;
                }
            });

            groupedBarChart.data.datasets[0].data = [uTrades, uWins, uLosses, uPnl];
            groupedBarChart.data.datasets[1].data = [mTrades, mWins, mLosses, mPnl];
            groupedBarChart.update('none');
        }

        function updateDonutCharts(metrics) {
            VARIANTS.forEach(v => {
                const chart = donutCharts[v];
                if (!chart) return;
                const m = metrics[v];
                if (!m) return;

                const wins = m.wins || 0;
                const losses = m.losses || 0;
                const pending = m.pending || 0;
                const total = wins + losses + pending;

                chart.data.datasets[0].data = total > 0 ? [wins, losses, pending] : [0, 0, 1];
                chart.update('none');
            });
        }

        function updatePnlLineChart(metrics, trades) {
            if (!pnlLineChart) return;

            // Track cumulative P&L over time
            const currentTotal = VARIANTS.reduce((sum, v) => sum + (metrics[v]?.total_trades || 0), 0);
            if (currentTotal > tradeCount) {
                tradeCount = currentTotal;
                const timestamp = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });

                pnlHistory.push({ time: timestamp, metrics: {} });
                VARIANTS.forEach(v => {
                    pnlHistory[pnlHistory.length - 1].metrics[v] = metrics[v]?.total_pnl || 0;
                });

                // Keep last 20 data points
                if (pnlHistory.length > 20) pnlHistory.shift();

                // Update chart
                pnlLineChart.data.labels = pnlHistory.map(h => h.time);
                VARIANTS.forEach((v, i) => {
                    pnlLineChart.data.datasets[i].data = pnlHistory.map(h => h.metrics[v] || 0);
                });
                pnlLineChart.update('none');
            }
        }

        function updateSparklines(metrics) {
            VARIANTS.forEach(v => {
                const chart = sparklineCharts[v];
                const valueEl = document.getElementById(`sparkline-value-${v}`);
                if (!chart) return;

                const m = metrics[v];
                const pnl = m?.total_pnl || 0;

                // Add latest P&L value
                const data = chart.data.datasets[0].data.slice(1);
                data.push(pnl);
                chart.data.datasets[0].data = data;
                chart.update('none');

                if (valueEl) {
                    valueEl.textContent = `$${pnl.toFixed(2)}`;
                    valueEl.className = 'sparkline-value ' + (pnl >= 0 ? 'pnl-positive' : 'pnl-negative');
                }
            });
        }

        // Option 6: Color-code table cells (heatmap)
        function applyHeatmapColors(metrics) {
            VARIANTS.forEach(v => {
                const m = metrics[v];
                if (!m) return;

                // P&L color
                const pnlEl = document.getElementById(`${v}-pnl`);
                if (pnlEl) {
                    const pnl = m.total_pnl || 0;
                    if (pnl > 0) pnlEl.style.backgroundColor = 'rgba(16, 185, 129, 0.15)';
                    else if (pnl < 0) pnlEl.style.backgroundColor = 'rgba(239, 68, 68, 0.15)';
                    else pnlEl.style.backgroundColor = 'transparent';
                }

                // Win rate color
                const winrateEl = document.getElementById(`${v}-winrate`);
                if (winrateEl) {
                    const wr = m.win_rate || 0;
                    if (wr >= 60) winrateEl.style.backgroundColor = 'rgba(16, 185, 129, 0.15)';
                    else if (wr >= 40) winrateEl.style.backgroundColor = 'rgba(251, 191, 36, 0.15)';
                    else if (wr > 0) winrateEl.style.backgroundColor = 'rgba(239, 68, 68, 0.15)';
                    else winrateEl.style.backgroundColor = 'transparent';
                }

                // ROI color
                const roiEl = document.getElementById(`${v}-roi`);
                if (roiEl) {
                    const roi = m.roi || 0;
                    if (roi > 0) roiEl.style.backgroundColor = 'rgba(16, 185, 129, 0.15)';
                    else if (roi < 0) roiEl.style.backgroundColor = 'rgba(239, 68, 68, 0.15)';
                    else roiEl.style.backgroundColor = 'transparent';
                }
            });
        }

        // Initialize charts after DOM loads
        document.addEventListener('DOMContentLoaded', () => {
            initCharts();
        });
    </script>
</body>

</html>